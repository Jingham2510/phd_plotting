"""
Script that plots the force_displacement data generated by rob_controls force_displacement testing

data format:
linenum date/time [x,y,z] [ori_x, ori_y, ori_z] [force_x,force_y,force_z,force_Rx,force_Ry,force_Rz]


It will plot the position, forces, velocity and acceleration

"""

import matplotlib.pyplot as plt
from tools import *


#Organise the plotting
def main(filepath, rust_check):

    datetimes = []
    pos = []
    ori = []
    forces = []

    #Open the file
    with open(filepath) as file:
        #Go through every line
        for line in file:
            #Ensure line is empty
            if line:
                #Split the line up
                tokens = data_split(line, rust_check)               
                
                #Append the time data
                datetimes.append(tokens[0])

                #Append the position data
                pos.append(tokens[1])
                
                #Append the force data
                ori.append(tokens[2])

                forces.append(tokens[3])


    #Calculate the time differences 
    time = calc_time_passed(datetimes, rust_check)



    #Turn the positions into numbers
    pos = str_to_array(pos)

    #Turn the forces into numbers
    force = str_to_array(forces)


    #Check that the data arrays are the same lengths
    if(not len(time) == len(pos) == len(forces)):
        print("DATA ARRAYS ARE INCONSISTENT LENGTH")

        print(f"time: {len(time)}, pos: {len(pos)}, forces: {len(forces)}")

        raise Exception()
    

    #Calculate the velocities
    vels = xyz_integ_avg(time, pos)   


    #Calculate the accelerations
    accs = xyz_integ_avg(time, three_arrs_to_threeD(vels[0], vels[1], vels[2]))

  
    #Create subfigure array for plots
    #We want to plot force vs pos?
    #Can decide later

    start = 0
    stop = 40000
    
    plot_force_history(force, time)
    #plot_pos(pos, time, True)
    #plot_force_vectors(pos[start:stop], force[start:stop], False)

    return


#Split the line up
#Not the most efficient but thats okay for now 
def data_split(line, rust):

    tokens = []

    #Can remove the line number
    line = line[line.find(",") + 1:]


    if (not rust):        

        #Can remove the date - will always be same length
        DATE_LENGTH = 11
        line = line[DATE_LENGTH:]

    #Save the time
    tokens.append(line[:line.find(",")])

    #Remove the time 
    line = line[line.find(",") + 2:]

    #Save the positions
    tokens.append(line[:line.find("]")])
    line = line[line.find("]") + 2:]

    #Save the orientations
    tokens.append(line[:line.find("]")])  
    line = line[line.find("]") + 2:] 
    #Save the forces
    tokens.append(line[:line.find("]")]) 



    return tokens



#Plot the  x vs y pos vs force
def plot_force_history(force, time):


    #Create force array contianing data of each axes
    forces  = [[],[],[],[],[],[]]

    
    #for i in force:
        #forces[0].append(abs(i[0]))
        #forces[1].append(abs(i[1]))
        #forces[2].append(abs(i[2]))
        #forces[3].append(abs(i[3]))
        #forces[4].append(abs(i[4]))
        #forces[5].append(abs(i[5]))
    
    for i in force:
        forces[0].append(i[0])
        forces[1].append(i[1])
        forces[2].append(i[2])
        #forces[3].append(i[3])
        #forces[4].append(i[4])
        #forces[5].append(i[5])
    

    fig, ax1 = plt.subplots()

    ax1.set_xlabel("Time (S)", fontsize=12)
    ax1.set_ylabel("Force (N)", fontsize=12)
    ax1.tick_params(axis="both", which="major", labelsize=12)


    start_val = 0
    
    #Colours selected using https://colorbrewer2.org/#type=qualitative&scheme=Dark2&n=3
    ax1.plot(time[start_val:], forces[0][start_val:],  label = "$F_x$", color="#1b9e77")
    ax1.plot(time[start_val:], forces[1][start_val:],  label = "$F_y$", color="#d95f02")
    #ax1.plot(time[start_val:], forces[2][start_val:],  label = "$F_z$", color="#7570b3")




    #ax2 = ax1.twinx()
    #ax2.set_ylabel("Moment (N/m)")
    
    #ax2.plot(time, forces[3],  label = "$M_x$", color="darkorange", linestyle="dashed", linewidth = "0.5")
    #ax2.plot(time, forces[4],  label = "$M_y$", color="navy", linestyle="dashed", linewidth = "0.5")
    #ax2.plot(time, forces[5],  label = "$M_z$", color="cyan", linestyle="dashed", linewidth = "0.5")
    
    
    fig.legend(prop={"size": 16})


    plt.show()


def plot_pos(pos, time, include_z):

    x = [i[0] for i in pos]
    y = [i[1] for i in pos]

    if include_z:
        z = [i[2] for i in pos]



    if not include_z:

        plt.plot(x[10:], y[10:])

        plt.xlabel("x (mm)", fontsize=12)
        plt.ylabel("y (mm)", fontsize=12)
        plt.tick_params(axis="both", which="major", labelsize=12)

        plt.show()

    else:

        ax = plt.figure().add_subplot(projection='3d')


        plt.plot(x[10:], y[10:], z[10:])

        plt.xlabel("x (mm)", fontsize=12)
        plt.ylabel("y (mm)", fontsize=12)
        ax.set_zlabel("z (mm)", fontsize=12)
        
        plt.tick_params(axis="x", which="major", labelsize=12)
        plt.xticks(range(261, 264))
        plt.tick_params(axis="y", which="major", labelsize=12)
        plt.tick_params(axis="z", which="major", labelsize=12)

        plt.show()


    return


"""
Plots the force vectors in 3D space
"""
def plot_force_vectors(pos,forces,threeD):   

    
    #Previous force vector determines next starting position
    x = []
    y = []
    z = []
    u = []
    v = []
    w = []

    #Create the force vectors
    for i in range(len(forces)):

        #Starting position is based on previous vector direction
        x.append(pos[i][0])
        y.append(pos[i][1])
        z.append(pos[i][2])

        #current vector direction based on applied forces
        u.append(forces[i][0])
        v.append(forces[i][1])
        w.append(forces[i][2])


    #Create the axes and figure

    if threeD:
        ax = plt.figure().add_subplot(projection="3d")

        ax.quiver(x, y, z, u, v, w, length = 0.01)

        ax.set_aspect("equal")

    else:
        plt.quiver(x, y, u, v)

    plt.show()




    return

if __name__ == "__main__":
    print("FORCE DISPLACEMENT PLOTTING ------------------")


    test_name = "slow_no_data_circle"

    filepath = "C:\\Users\\User\\Documents\\Results\\DEPTH_TESTS\\" + test_name + "\\data_" + test_name + ".txt"

    main(filepath, True)
